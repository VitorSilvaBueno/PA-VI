<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <title>Controller</title>
</head>

<body>
    <canvas id="controller"></canvas>
    <script>
        const yourIP = "localhost"
        var io = io.connect(`http://${yourIP}:8080/`);
    
        const controller = document.getElementById("controller")
        const ctx = controller.getContext("2d")
        controller.width = window.innerWidth;
        controller.height = window.innerHeight;

        ctx.lineWidth = 3;

        const pen = {
            start: null,
            end: { x: 0, y: 0 },
            active: false,
            moving: false,
            color: '#' + Math.floor(Math.random() * 16777215).toString(16)
        }

        const drawLine = (line) => {
            ctx.beginPath();
            ctx.moveTo(line.start.x, line.start.y);
            ctx.lineTo(line.end.x, line.end.y);
            ctx.strokeStyle = pen.color;
            console.log(pen.color);
            ctx.stroke();
        }

        controller.onmousemove = (e) => {
            pen.end.x = e.clientX
            pen.end.y = e.clientY
            pen.moving = true
        }

        controller.onmousedown = () => { pen.active = true };

        controller.onmouseup = () => { pen.active = false };

        controller.addEventListener('touchmove', (e) => {
            pen.active = true;
            pen.end.x = e.touches[0].clientX;
            pen.end.y = e.touches[0].clientY;
            pen.moving = true
        })

        controller.addEventListener('touchstart', (e) => {
            pen.end.x = e.touches[0].clientX;
            pen.end.y = e.touches[0].clientY;
        });
        
        controller.addEventListener('touchend', (e) => { 
            pen.active = false;
            pen.end.x = e.touches[0].clientX;
            pen.end.y = e.touches[0].clientY;
        });

        const drawing = () => {
            if (pen.active && pen.moving && pen.start) {
                io.emit('draw', pen)
                drawLine({ end: pen.end, start: pen.start })
                pen.moving = false
            }
            pen.start = { x: pen.end.x, y: pen.end.y }
            window.requestAnimationFrame(drawing);
        }
        drawing()
    </script>
</body>
</html>
